
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>如何在你自己的服务器搭建类似github的服务,git部署站点</title>
    
    <meta name="author" content="xiaoshenge">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="/assets/themes/bootstrap-3/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="/assets/themes/bootstrap-3/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">xiaoshenge</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
      	
      	<li><a href="/Myinfo.html">about me</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
  
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  



          </ul>
          <form class="navbar-form navbar-right" role="search">
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Search">
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>如何在你自己的服务器搭建类似github的服务,git部署站点 </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>09 October 2012</span>
    </div>
    <div class="content">
      <h2 id="section">分支开发</h2>
<p><a href="http://www.oschina.net/translate/a-successful-git-branching-model">介绍一个成功的 Git 分支模型</a></p>

<p><a href="http://nvie.com/posts/a-successful-git-branching-model/">A successful Git branching model</a></p>

<p>前言：如果你使用git管理代码（不希望公开的），但是没有钱买github的服务，你可以再自己的服务器上搭建git服务器（这里只写支持ssh协议的，与github差的太远了，希望不要怪我这个标题党）。同时如果你用git部署项目的话，只需要一条pull命令就可以把测试机上的代码更新到线上(之前我还傻傻的登录线上机子然后pull，其实只需要在本地push一下就好)。</p>

<p>参考资料：<a href="http://www.ooso.net/archives/596">《git权威指南》</a></p>

<p>-.搭建支持ssh协议的git服务器</p>

<p>1：linux服务器上安装好git(可以参考：<a href="http://help.github.com/linux-set-up-git/">http://help.github.com/linux-set-up-git/</a>)</p>

<p>2：本地安装git软件（参考：<a href="http://help.github.com">http://help.github.com</a> 里面的set up git）</p>

<p>3：给支持git操作的用户添加认证信息，在用户家目录（~/home）新建.ssh文件夹：将本地（就你开发机子上的~/.ssh/id_rsa.pub）添加到服务器上~/.ssh/authorized_keys <a href="https://help.github.com/articles/generating-ssh-keys">Generating SSH Keys</a></p>

<p>4：在linux服务器上创建项目的共享版本库</p>

<pre><code>git init --bare --share;
git update-server-info
</code></pre>

<p>5:然后你就可以使用了，操作跟你操作github一样（ git clone 添加了认证信息的用户名@服务器域名（或者ip）:/项目路径）</p>

<p>二.git部署你的项目</p>

<p>1：.在你部署的机子上通过git clone把版本库中的代码克隆一份</p>

<p>2：设置部署机上的项目git配置</p>

<pre><code>git config receive.denyCurrentBranch ignore
git config --bool receive.denyNonFastForwards false
 
cd .git/hooks
wget http://utsl.gen.nz/git/post-update
chmod +x post-update
</code></pre>

<p>vim post-update</p>

<pre><code>#!/bin/sh
#
# This hook does two things:
#
#  1. update the "info" files that allow the list of references to be
#     queries over dumb transports such as http
#
#  2. if this repository looks like it is a non-bare repository, and
#     the checked-out branch is pushed to, then update the working copy.
#     This makes "push" function somewhat similarly to darcs and bzr.
#
# To enable this hook, make this file executable by "chmod +x post-update".

git update-server-info

is_bare=$(git config --get --bool core.bare)

if [ -z "$is_bare" ]
then
    # for compatibility's sake, guess
    git_dir_full=$(cd $GIT_DIR; pwd)
    case $git_dir_full in */.git) is_bare=false;; *) is_bare=true;; esac
fi

update_wc() {
    ref=$1
    echo "Push to checked out branch $ref" &gt;&amp;2
    if [ ! -f $GIT_DIR/logs/HEAD ]
    then
        echo "E:push to non-bare repository requires a HEAD reflog" &gt;&amp;2
        exit 1
    fi
    if (cd $GIT_WORK_TREE; git diff-files -q --exit-code &gt;/dev/null)
    then
        wc_dirty=0
    else
        echo "W:unstaged changes found in working copy" &gt;&amp;2
        wc_dirty=1
        desc="working copy"
    fi
    if git diff-index --cached HEAD@{1} &gt;/dev/null
    then
        index_dirty=0
    else
        echo "W:uncommitted, staged changes found" &gt;&amp;2
        index_dirty=1
        if [ -n "$desc" ]
        then
            desc="$desc and index"
        else
            desc="index"
        fi
    fi
    if [ "$wc_dirty" -ne 0 -o "$index_dirty" -ne 0 ]
    then
        new=$(git rev-parse HEAD)
        echo "W:stashing dirty $desc - see git-stash(1)" &gt;&amp;2
        ( trap 'echo trapped $$; git symbolic-ref HEAD "'"$ref"'"' 2 3 13 15 ERR EXIT
        git update-ref --no-deref HEAD HEAD@{1}
        cd $GIT_WORK_TREE
        git stash save "dirty $desc before update to $new";
        git symbolic-ref HEAD "$ref"
        )
    fi

    # eye candy - show the WC updates :)
    echo "Updating working copy" &gt;&amp;2
    (cd $GIT_WORK_TREE
    git diff-index -R --name-status HEAD &gt;&amp;2
    git reset --hard HEAD)
}

if [ "$is_bare" = "false" ]
then
    active_branch=`git symbolic-ref HEAD`
    export GIT_DIR=$(cd $GIT_DIR; pwd)
    GIT_WORK_TREE=${GIT_WORK_TREE-..}
    for ref
    do
        if [ "$ref" = "$active_branch" ]
        then
            update_wc $ref
        fi
    done
fi 3:设置你本地版本库
 
[remote "web"]
    url = your-ssh-username@your-host:/var/www/yoursite/ 4:然后你就可以

git psuh origin master（更新到版本库）
git push web（更新到线上）
</code></pre>

<p>如果你有这个需求，同时我这篇文章误导你了（没看明白我写啥，可以email我）。</p>

<p>——————————–华丽的分界线（以下部分是之前的自己的备忘录）———————————————</p>

<p>我们知道git支持很多协议，这里想说的是本地和ssh。</p>

<p>本地就是你的代码库分别在两个盘：</p>

<p>在d盘的test目录生成不包含工作区的版本库</p>

<p>d:/test/  git init –bare</p>

<p>然后在e盘就可以用了</p>

<p>e: git clone d:/test</p>

<p>…</p>

<p>e:/test git push oringin master</p>

<p>在网络中就是通过ssh连接到你的服务器：</p>

<p>在你的服务器建立git用户：</p>

<p>$ sudo adduser git
$ su git
$ cd
$ mkdir .ssh</p>

<p>然后你自己的本地的~/.ssh/id_rsa.pub添加到服务器上~/.ssh/authorized_keys</p>

<p>然后用git用户创建版本库</p>

<p>cd /var/www/gitcode/test</p>

<p>git init –bare –share</p>

<p>git update-server-info</p>

<p>然后你本地就可以使用了
$ git clone git@youserver:/var/www/gitcode/test
….
$ git push origin master</p>

<p>然后你就可以尽情使用git了。</p>

<p>最后再次感谢github管理员在大过年的帮我解决问题（昨晚平安夜发的问题）。</p>

<p>还有这个http://progit.org/，你可以学习很多git知识。</p>

<p>git部署站点：</p>

<p>上面说到搭建git没有工作区间的版本库，当我们需要部署该代码时候。（比如web服务器也在git版本库管理机子上）</p>

<p>cd /var/www/test</p>

<p>git clone /var/www/gitcode/test</p>

<p>web服务器就省略了…</p>

<p>也许我们是本地开发，我们本地有个版本，修改完了git push origin master</p>

<p>然后在登陆到web服务器下面git pull，才实现代码一致，我想可能有简单办法，自己对git不熟悉，刚好看到这篇文章。http://www.ooso.net/archives/596</p>

<p>在web部署的库中：</p>

<p>git config receive.denyCurrentBranch ignore</p>

<p>git config –bool receive.denyNonFastForwards false</p>

<p>给web下面的代码加上git用户可写的权限，</p>

<p>cd .git/hooks
wget http://utsl.gen.nz/git/post-update
chmod +x post-update
在本地库加上</p>

<p>[remote “webdev”]</p>

<pre><code>    url = your-ssh-username@your-host:/var/www/yoursite/
</code></pre>

<p>然后你就可以</p>

<p>git psuh origin master</p>

<p>git push webdev</p>

<p>省去了在登陆web服务器pull的步骤。</p>

<p>这么强大的git了这是值得学习。</p>

<p>[注]：大部分的git push失败都是有权限导致的，当push失败（除冲突除外），先去检查权限问题。</p>


    </div>



  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="/skill/2012/10/01/git-SSL3_GET_SERVER_CERTIFICATE" title="HOW TO FIX A GIT SSL3_GET_SERVER_CERTIFICATE ERROR">&laquo; Previous</a></li>
    
      <li><a href="/archive.html">Archive</a></li>
    
      <li class="next"><a href="/skill/2012/10/09/svn" title="常用svn操作">Next &raquo;</a></li>
    
    </ul>
    <hr>
    
  </div>
</div>


      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2014 xiaoshenge
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </div>
    </div id="footer">

    


    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="/assets/themes/bootstrap-3/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>

